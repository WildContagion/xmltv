# Define the stages for your CI/CD pipeline
stages:
  - generate
  - deploy # Keeping a deploy stage separate for future actions like serving the guide

# 1. Define the base environment for the job
image: python:3.10

# 2. Define the job
xmltv_generator_job:
  stage: generate
  
  # 3. Cache the pip dependencies to speed up subsequent runs
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .cache/pip
  
  # 4. Define when this job should run (Triggers)
  rules:
    # Schedule: Equivalent to 'cron: "0 4 * * *"' in GitHub Actions
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: always
      
    # Workflow_dispatch / Manual: Allows manual run through the UI
    - if: $CI_PIPELINE_SOURCE == "web"
      when: always
      
    # Push to 'main' branch, but only if paths match (The path filtering is a bit complex in pure rules, 
    # but $CI_COMMIT_BRANCH == "main" is the basic check)
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - '.gitlab-ci.yml' # Check for changes in this specific file
      when: always
      
    # If no rule matches, skip the job
    - when: never
      
  # 5. The actual execution steps
  before_script:
    - apt-get update && apt-get install -y git >/dev/null
    
    # Setup pip cache directory (for the shared 'cache' block)
    - export PIP_CACHE_DIR=".cache/pip"
    - mkdir -p $PIP_CACHE_DIR

  script:
    - echo "Installing dependencies..."
    - pip install -r requirements.txt
    
    # Run the generation scripts
    - echo "Executing XMLTV generation scripts..."
    - python ./scripts/gracenote_to_xmltv.py ./channels/gracenote/gracenote.channels.xml -o ./guide/gracenote.xml
    - python ./scripts/gracenote_to_xmltv.py ./channels/gracenote/USA-C-BAND-DEFAULT.channels.xml -o ./guide/USA-C-BAND-DEFAULT.xml
    - python ./scripts/gracenote_to_xmltv.py ./channels/gracenote/USA-GNSTR-DEFAULT.channels.xml -o ./guide/USA-GNSTR-DEFAULT.xml
    
    # Compress the main guide file
    - echo "Compressing guide file..."
    - gzip -c ./guide/gracenote.xml > ./guide/gracenote.xml.gz

    # --- Git Commit/Push Section (Alternative/Advanced) ---
    # WARNING: This requires a Gitlab Deploy Token or user to be configured 
    # to push back to the repository. The preferred GitLab method is to use 
    # artifacts or a separate deployment job.
    # 
    # - echo "Configuring Git and pushing changes..."
    # - git config user.name "gitlab-ci[bot]"
    # - git config user.email "gitlab-ci[bot]@users.noreply.gitlab.com"
    # - git remote set-url origin "https://oauth2:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    # - git add --force ./guide
    # - git commit -m "Update Gracenote XMLTV" || echo "No changes to commit"
    # - git push origin $CI_COMMIT_BRANCH
    
    - echo "Configuring Git and pushing changes with CI_JOB_TOKEN..."
    - git config --global user.name ${GITLAB_USER_NAME}
    - git config --global user.email ${GITLAB_USER_EMAIL}

    # Configure the remote URL using the CI_JOB_TOKEN
    - git remote set-url origin "https://oauth2:${GITLAB_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    
    - git add --force guide
    - git commit -m "Update XMLTV" || echo "No changes to commit"
    - git push -u origin HEAD:main
    
  # 6. Store the generated files as artifacts for download or use in later stages
  artifacts:
    paths:
      - ./guide/
    expire_in: 1 week # How long to keep the downloadable files
