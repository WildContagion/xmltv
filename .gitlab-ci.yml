# .gitlab-ci.yml

# Stages: Jobs in the same stage run in parallel. The next stage starts when all jobs in the current stage are complete.
stages:
  - build

# Cache: Caching the pip environment for faster runs.
# The 'pip' cache key can be simplified to just a file list.
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .venv
    - /usr/local/lib/python3.10/site-packages
  policy: pull-push

# Define the Python image to use for the job.
# This replaces `runs-on: ubuntu-latest` and part of `actions/setup-python@v5`.
# We use a specific Python 3.10 image from Docker Hub.
image: python:3.10-slim

# The 'load' job definition
load:
  stage: build
  
  # Before any script runs, set up the Python environment and install dependencies.
  # This replaces the `Set up Python` and `Install dependencies` steps.
  before_script:
    # Use venv for a cleaner environment setup
    - python -m venv .venv
    - source .venv/bin/activate
    - python -m pip install --upgrade pip
    - pip install -r requirements.txt
  
  # Script: The main execution steps. This replaces the `execute py script` and `Commit and Push Changes` steps.
  script:
    - python ./scripts/gracenote_to_xmltv.py ./channels/gracenote/gracenote.channels.xml -o ./guide/gracenote.xml
    - python ./scripts/gracenote_to_xmltv.py ./channels/gracenote/USA-C-BAND-DEFAULT.channels.xml -o ./guide/USA-C-BAND-DEFAULT.xml
    - python ./scripts/gracenote_to_xmltv.py ./channels/gracenote/USA-GNSTR-DEFAULT.channels.xml -o ./guide/USA-GNSTR-DEFAULT.xml
    - gzip -c ./guide/gracenote.xml > ./guide/gracenote.xml.gz
    
    # Git commit and push logic
    # Note: For pushing, you'll need to use a personal access token stored in a CI/CD variable 
    # instead of hardcoding user/email. $GITLAB_TOKEN is a common placeholder.
    # The `&& break` is removed as it's not standard in a shell script for this purpose.
    - git config --global user.name 'bot-1zk1i0zj6u'
    - git config --global user.email 'bot-1zk1i0zj6u@example.com'
    - git add --force ./guide
    - git commit -m "Update Gracenote XMLTV" || echo "No changes to commit" # '|| echo "..."' prevents failure if no changes
    - git push http://oauth2:$GITLAB_TOKEN@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git HEAD:main || echo "Failed to push or branch is up-to-date"

  # Rules: Define when and how the job should run. This replaces the `on:` block.
  rules:
    # 1. Scheduled run (equivalent to cron: "0 4 * * *")
    - if: $CI_PIPELINE_SOURCE == "schedule"
      variables:
        # A simple placeholder variable if you need to distinguish schedule runs.
        SCHEDULE_RUN: "true"

    # 2. Manual run (equivalent to workflow_dispatch)
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
      allow_failure: false # Allow a manual trigger to run by default

    # 3. Prevent automatic runs on push/merge to avoid creating infinite loops with the git push step
    - when: never 

# --------------------------------------------------------------------------------------
# Optional: To use the `bot-1zk1i0zj6u` user/email without having a hardcoded token in the URL,
# you can use GitLab's built-in CI_JOB_TOKEN for read/write access to the repository:
#
# script:
#   # ... previous commands
#   - git config user.name 'bot-1zk1i0zj6u'
#   - git config user.email 'bot-1zk1i0zj6u@example.com'
#   - git add --force ./guide
#   - git commit -m "Update Gracenote XMLTV" || echo "No changes to commit"
#   - git push "https://${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" HEAD:main || echo "Failed to push or branch is up-to-date"
