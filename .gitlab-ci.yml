# .gitlab-ci.yml

# Define the stages (optional but good practice)
stages:
  - build
  - deploy

# Define a cache for Python dependencies
cache:
  paths:
    - .venv/

# --- Job to Load and Generate XMLTV ---
xmltv_generator:
  stage: build
  
  # Use a suitable Docker image with Python 3.10
  image: python:3.10-slim
  
  # Control when the job runs
  rules:
    # 1. Run on a schedule (cron equivalent)
    - if: $CI_PIPELINE_SOURCE == "schedule"
    # 2. Run on manual workflow_dispatch (equivalent to a manual trigger)
    - if: $CI_PIPELINE_SOURCE == "web"
    # 3. Run on push to main branch, only if paths are modified
    - if: $CI_COMMIT_BRANCH == "main" && ($CI_COMMIT_BEFORE_SHA != "0000000000000000000000000000000000000000" && changes)
      changes:
        - '.gitlab-ci.yml'
      
  # Define the necessary commands to run
  script:
    - echo "Setting up Python environment and dependencies..."
    # Set up a virtual environment and use the cache
    - python -m venv .venv
    - source .venv/bin/activate
    
    # Install dependencies
    - pip install --upgrade pip
    - pip install -r requirements.txt
   
    echo "Executing Python scripts to generate XMLTV files..."
    # Execute Python scripts
    - python ./scripts/gracenote_to_xmltv.py ./channels/gracenote/gracenote.channels.xml -o ./guide/gracenote.xml
    - python ./scripts/gracenote_to_xmltv.py ./channels/gracenote/USA-C-BAND-DEFAULT.channels.xml -o ./guide/USA-C-BAND-DEFAULT.xml
    - python ./scripts/gracenote_to_xmltv.py ./channels/gracenote/USA-GNSTR-DEFAULT.channels.xml -o ./guide/USA-GNSTR-DEFAULT.xml
    
    # Gzip the main file
    - gzip -c ./guide/gracenote.xml > ./guide/gracenote.xml.gz
    
    echo "Committing and pushing changes..."
    # The following steps require you to configure a **CI/CD Access Token** # with `write_repository` permissions for the GitLab user associated with the token.
    # The token should be stored in a CI/CD Variable named `GITLAB_PUSH_TOKEN` or similar.
    # We will use the built-in $CI_JOB_TOKEN for read access, but a dedicated token is better for push.
    # Assuming you set up a variable like $GITLAB_PUSH_TOKEN
    
    # Configure Git
    - git config --global user.name 'bot-1zk1i0zj6u'
    - git config --global user.email 'bot-1zk1i0zj6u@example.com'
    
    # Ensure the repository URL uses the token for pushing
    - REMOTE_URL="https://Arkina1234:${GITLAB_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    
    # Add, Commit, and Push
    - git add --force ./guide
    - git commit -m "Update Gracenote XMLTV [skip ci]" || echo "No changes to commit"
    # The [skip ci] prevents an infinite loop of pipeline triggers
    - git push "${REMOTE_URL}" HEAD:main
    
  # Define which files to save as artifacts (optional, but good for inspection)
  artifacts:
    paths:
      - ./guide/
    expire_in: 1 day
